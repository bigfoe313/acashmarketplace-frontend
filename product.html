<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Detail</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .product-card {
      background: white;
      padding: 10px;
      border-radius: 10px;
      border: 2px solid #ccc;
      box-shadow: 0px 3px 8px rgba(0, 0, 0, 0.12);
      display: inline-block;
      max-width: 400px;
      text-align: center;
    }
    .product-card img {
      max-width: 100%;
      border-radius: 8px;
    }
    .price-info p {
      margin: 4px 0;
    }
    .buy-now-btn {
      display: block;
      width: 100%;
      padding: 8px;
      margin-top: 8px;
      background-color: #0070f3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .buy-now-btn:hover {
      background-color: #005bb5;
    }
    .metamask-btn {
      display: block;
      background-color: #28a745;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      padding: 10px 12px;
      margin-top: 8px;
      transition: background-color 0.2s ease;
      cursor: pointer;
    }
    .metamask-btn:hover {
      background-color: #218838;
    }
    .mm-text {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .mm-line1 { font-size: 0.9rem; font-weight: 600; margin-bottom: 4px; color: white; }
    .mm-price-row { display: flex; align-items: center; gap: 6px; }
    .mm-line2 { font-size: 1rem; font-weight: bold; color: white; }
    .metamask-logo { width: 20px; height: 20px; }
    .or-divider { display:flex; align-items:center; justify-content:center; margin-top:8px; }
    .or-divider div { flex:1;border-bottom:1px solid #ccc; margin:0 8px; }
  </style>
</head>
<body>

<div id="productContainer"></div>

<script>
const API_BASE = "https://acashmarketplace-backend.onrender.com";

/* === STATE SALES TAX RATES === */
const stateTaxRates = {
  AL:4, AK:0, AZ:5.6, AR:6.5, CA:7.25, CO:2.9, CT:6.35, DE:0,
  FL:6, GA:4, HI:4, ID:6, IL:6.25, IN:7, IA:6, KS:6.5,
  KY:6, LA:4.45, ME:5.5, MD:6, MA:6.25, MI:6, MN:6.875,
  MS:7, MO:4.225, MT:0, NE:5.5, NV:6.85, NH:0, NJ:6.625,
  NM:5.125, NY:4, NC:4.75, ND:5, OH:5.75, OK:4.5, OR:0,
  PA:6, RI:7, SC:6, SD:4.5, TN:7, TX:6.25, UT:4.85,
  VT:6, VA:5.3, WA:6.5, WV:6, WI:5, WY:4, DC:6
};

// Parse product data
const urlParams = new URLSearchParams(window.location.search);
const product = {
  id: urlParams.get("id"),
  title: decodeURIComponent(urlParams.get("title") || ""),
  price: parseFloat(urlParams.get("price") || 0),
  shipping: parseFloat(urlParams.get("shipping") || 0),
  image: decodeURIComponent(urlParams.get("image") || ""),
  skuId: urlParams.get("skuId") || "",
  minDelivery: urlParams.get("minDelivery") || "N/A",
  maxDelivery: urlParams.get("maxDelivery") || "N/A"
};

const container = document.getElementById("productContainer");
const discountPrice = (product.price * 0.9).toFixed(2);
const delivery =
  product.minDelivery !== "N/A" && product.maxDelivery !== "N/A"
    ? `${product.minDelivery}-${product.maxDelivery} Days`
    : "N/A";

const proxyImage = (url) =>
  url ? `${API_BASE}/api/image-proxy?url=${encodeURIComponent(url)}` : "";

/* === TAX CALC === */
const updateTotalPrice = () => {
  const state = document.getElementById("state").value;
  const subtotal = product.price + product.shipping;
  const taxRate = state ? (stateTaxRates[state] || 0) / 100 : 0;
  const salesTax = subtotal * taxRate;
  const total = subtotal + salesTax;

  document.getElementById("salesTaxLine").style.display =
    state && taxRate > 0 ? "block" : "none";
  document.getElementById("salesTaxAmount").textContent =
    `$${salesTax.toFixed(2)}`;
  document.getElementById("totalPrice").textContent =
    `$${total.toFixed(2)}`;

  return { salesTax, total };
};

(async () => {
  try {
    let skuImage = product.image;

    const resp = await fetch(`${API_BASE}/api/metamask-checkout`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(product)
    });

    const json = await resp.json();
    if (json?.cart?.image) skuImage = json.cart.image;

    container.innerHTML = `
      <div class="product-card">
        <img src="${proxyImage(skuImage)}" />
        <h3>${product.title}</h3>

        <div class="price-info">
          <p>Price: <strong>$${product.price.toFixed(2)}</strong></p>
          <p>Shipping: <strong>$${product.shipping.toFixed(2)}</strong></p>
          <p id="salesTaxLine" style="display:none">
            Sales Tax: <strong id="salesTaxAmount">$0.00</strong>
          </p>
          <p>Total: <strong id="totalPrice">$${(product.price + product.shipping).toFixed(2)}</strong></p>
          <p>Delivery: ${delivery}</p>
        </div>

        <label>State</label>
        <select id="state">
          <option value="">Select a state</option>
          ${Object.keys(stateTaxRates).map(s => `<option value="${s}">${s}</option>`).join("")}
        </select>

        <button class="buy-now-btn" id="buyNowBtn">Buy Now</button>

        <div class="or-divider"><div></div><span>OR</span><div></div></div>

        <a href="#" id="metamaskBtn" class="metamask-btn">
          <div class="mm-text">
            <span class="mm-line1">Buy with 10% Discount</span>
            <span class="mm-line2"><strong>${discountPrice} A-CASH</strong></span>
          </div>
        </a>
      </div>
    `;

    document.getElementById("state").addEventListener("change", updateTotalPrice);

    document.getElementById("buyNowBtn").addEventListener("click", async () => {
      const { salesTax, total } = updateTotalPrice();

      const resp = await fetch(`${API_BASE}/api/cart/add`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ...product,
          image: skuImage,
          stateSalesTax: salesTax,
          totalPriceWithTax: total
        })
      });

      const data = await resp.json();
      if (data.url) window.open(data.url, "_blank");
    });

  } catch (err) {
    console.error(err);
    container.innerHTML = `<div class="product-card">Failed to load product</div>`;
  }
})();
</script>
</body>
</html>
